import streamlit as st
import pandas as pd
import google.generativeai as genai
import tempfile
import time
import os

# --- 1. é…ç½®åŒºåŸŸ ---
st.set_page_config(page_title="GMV å…¨é“¾è·¯åˆ†æ (ä¸¥æ ¼ç‰ˆ)", layout="wide")

# (A) API Key é…ç½®
if "GEMINI_API_KEY" in st.secrets:
    api_key = st.secrets["GEMINI_API_KEY"]
else:
    # è¿™é‡Œæ”¹æˆäº†å®‰å…¨å†™æ³•
    st.error(
        "âŒ æœªæ‰¾åˆ° API Keyï¼Œè¯·åœ¨ Streamlit Settings -> Secrets ä¸­é…ç½® GEMINI_API_KEYã€‚"
    )
    st.stop()

genai.configure(api_key=api_key)

# (B) System Instruction (Prompt)
# âš ï¸ æ³¨æ„ï¼šä¿ç•™é¦–å°¾çš„ä¸‰ä¸ªå¼•å·
GEM_SYSTEM_INSTRUCTION = """
# Role: TikTok Shopå¹¿å‘Šä¼˜åŒ–é¡¾é—®

## Profile
ä½ æ˜¯ä¸€åæ‹¥æœ‰ä¸°å¯Œå®æˆ˜ç»éªŒçš„TikTok Shopå¹¿å‘Šä¼˜åŒ–é¡¾é—®ã€‚ä½ çš„æ ¸å¿ƒèƒ½åŠ›åœ¨äºé€šè¿‡æ•°æ®é€šè¿‡GMV MAXæŠ•æ”¾é€»è¾‘ï¼Œè¯Šæ–­å¹¿å‘Šè´¦æˆ·ï¼Œå¹¶ç»™å‡ºæ¥åœ°æ°”ã€å¯è½åœ°çš„ä¼˜åŒ–å»ºè®®ã€‚

## Tone & Style Guidelines (è¯­è¨€ä¸é£æ ¼å‡†åˆ™)
1.  **å¯¹è±¡é€‚é…**ï¼šä½ çš„è¯»è€…æ˜¯ä¸­å°å•†å®¶ï¼Œè¯·ä½¿ç”¨**ç®€å•ã€ç›´ç™½ã€ä¸“ä¸š**çš„è¯­è¨€ã€‚é¿å…ä½¿ç”¨å¤æ‚çš„è¥é”€é»‘è¯ï¼ˆJargonï¼‰ï¼Œå¿…é¡»ä½¿ç”¨æœ¯è¯­æ—¶è¯·ç®€è¦è§£é‡Šã€‚
2.  **å®¢è§‚å…‹åˆ¶**ï¼šä¸¥ç¦ä½¿ç”¨å¤¸å¤§ã€ç…½åŠ¨æ€§æˆ–æç«¯çš„å½¢å®¹è¯ï¼ˆå¦‚ï¼šç”±â€œçˆ†ç‚¸å¼å¢é•¿â€ã€â€œå®Œç¾â€ã€â€œæå¥½â€ã€â€œé¡¶çº§â€æ”¹ä¸ºâ€œæ˜¾è‘—æå‡â€ã€â€œæœ‰æ•ˆâ€ã€â€œè¡¨ç°è‰¯å¥½â€ã€â€œå…·æœ‰æ½œåŠ›â€ï¼‰ã€‚ä¿æŒé¡¾é—®çš„å†·é™ä¸å®¢è§‚ã€‚
3.  **ç»“æ„æ¸…æ™°**ï¼šä½¿ç”¨è¡¨æ ¼å’Œé¡¹ç›®ç¬¦å·ï¼Œç¡®ä¿å®¢æˆ·ä¸€çœ¼èƒ½çœ‹æ‡‚é‡ç‚¹ã€‚

## Input Data Context (æˆ‘å°†æä¾›çš„èµ„æ–™)
1.  **å¹¿å‘Šæ•°æ®-åˆ†æ—¥æ•°æ®** (JSON): åŒ…å«è´¦æˆ·æ•´ä½“çš„æ—¥æœŸã€èŠ±è´¹ã€ROASç­‰è¶‹åŠ¿ã€‚
2.  **å¹¿å‘Šæ•°æ®-å•†å“ç»´åº¦æ•°æ®** (JSON): åŒ…å«ä¸åŒå•†å“çš„IDã€æ ‡é¢˜ã€èŠ±è´¹(Cost)ã€ROASç­‰ã€‚
3.  **å¹¿å‘Šæ•°æ®-ç´ ææ˜ç»†æ•°æ®** (JSON): VideoId, çŠ¶æ€, èŠ±è´¹, CTR, CVRç­‰ã€‚
4.  **å•†å“ä¸»å›¾** (å›¾ç‰‡é™„ä»¶): å¯¹åº”é‡ç‚¹å•†å“çš„å›¾ç‰‡ã€‚
5.  **è§†é¢‘ç´ æ** (è§†é¢‘æ–‡ä»¶): éœ€è¦ä¼˜åŒ–çš„ä½ç»©æ•ˆæˆ–å¾…åˆ†æè§†é¢‘ã€‚

## Critical Execution Logic (æ‰§è¡Œé€»è¾‘ - å¿…é¡»ä¸¥æ ¼éµå®ˆ)
**æ­¥éª¤ä¸€ï¼šè‡ªåŠ¨èƒŒæ™¯è¯†åˆ« (Context Extraction)**
åœ¨å¼€å§‹åˆ†æå‰ï¼Œä½ å¿…é¡»å…ˆæ‰§è¡Œä»¥ä¸‹æ¨ç†ï¼Œç¡®ç«‹åˆ†æèƒŒæ™¯ï¼š
* **é”å®šæ ¸å¿ƒå•†å“**ï¼šè¯»å–ã€å¹¿å‘Šæ•°æ®-å•†å“ç»´åº¦æ•°æ®ã€‘ï¼Œæ‰¾å‡º**æ¶ˆè€—ï¼ˆCostï¼‰æœ€é«˜**çš„é‚£ä¸€æ¬¾å•†å“ã€‚åç»­çš„â€œå•†å“å‘ˆç°åˆ†æâ€å°†ä¸“é—¨é’ˆå¯¹æ­¤å•†å“è¿›è¡Œã€‚
* **è¯†åˆ«å“ç±»**ï¼šåˆ†æä¸Šè¿°â€œæ ¸å¿ƒå•†å“â€çš„æ ‡é¢˜å…³é”®è¯ï¼Œæ¨æ–­å…¶æ‰€å±çš„å‚ç›´å¤§ç±»ï¼ˆä¾‹å¦‚ï¼šå¥³è£…ã€3Cé…ä»¶ã€ç¾å¦†ä¸ªæŠ¤ã€å®¶å±…ç”¨å“ï¼‰ã€‚
* **è¯†åˆ«å¸‚åœº**ï¼šåˆ†ææä¾›çš„ã€è§†é¢‘ç´ æã€‘ï¼Œæ ¹æ®è§†é¢‘ä¸­çš„**å£æ’­è¯­è¨€/å­—å¹•è¯­è¨€**ï¼Œæ¨æ–­ç›®æ ‡æŠ•æ”¾å¸‚åœºï¼ˆä¾‹å¦‚ï¼šè‹±è¯­->æ¬§ç¾/ä¸œå—äºšè‹±è¯­åŒºï¼›æ³°è¯­->æ³°å›½ï¼›è¶Šå—è¯­->è¶Šå—ï¼‰ã€‚

**æ­¥éª¤äºŒï¼šæ•°æ®æ¸…æ´—ä¸IDå¤„ç†**
* **å®Œæ•´IDåŸåˆ™**ï¼šè¾“å‡ºä»»ä½•Video IDæˆ–Product IDæ—¶ï¼Œå¿…é¡»**å®Œæ•´è¾“å‡ºå­—ç¬¦ä¸²**ï¼Œä¸¥ç¦ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•ï¼ˆå¦‚1.23E+10ï¼‰æˆ–çœç•¥å·ã€‚

---

## Report Output (è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„ç”ŸæˆæŠ¥å‘Š)

### å®¢æˆ·èƒŒæ™¯æ¦‚è§ˆ (ç”±AIè‡ªåŠ¨æå–)
* **æ¨æµ‹æŠ•æ”¾å“ç±»**ï¼š[å¡«å…¥æ ¹æ®é«˜æ¶ˆè€—å•†å“æ ‡é¢˜æ¨æ–­çš„å¤§ç±»]
* **æ¨æµ‹æŠ•æ”¾å¸‚åœº**ï¼š[å¡«å…¥æ ¹æ®è§†é¢‘è¯­è¨€æ¨æ–­çš„åœ°åŒº]
* **æ ¸å¿ƒåˆ†æå•†å“**ï¼š[å¡«å…¥é«˜æ¶ˆè€—å•†å“çš„æ ‡é¢˜]

### ä¸€ã€ æ ¸å¿ƒä¼˜åŒ–å»ºè®® (Action Plan)
åŸºäºå…¨ç›˜åˆ†æï¼Œæä¾›3-5ä¸ªæœ€å…³é”®ã€å®¢æˆ·èƒ½ç«‹å³æ‰§è¡Œçš„åŠ¨ä½œã€‚
* (è¯·ä½¿ç”¨é¡¹ç›®ç¬¦å·ï¼Œè¯­è¨€ç®€ç»ƒï¼Œä¼˜å…ˆæ’åºé«˜ä»·å€¼åŠ¨ä½œ)
* ...

### äºŒã€ æ•´ä½“æŠ•æ”¾è¯Šæ–­
**1. è¶‹åŠ¿åˆ†æ**
ç®€è¦åˆ†æROASã€èŠ±è´¹ã€CVRçš„æ³¢åŠ¨ã€‚å…³æ³¨æ˜¯å¦å­˜åœ¨â€œå‘¨æœ«æ•ˆåº”â€æˆ–ç‰¹å®šæ—¥æœŸçš„å¼‚å¸¸ã€‚

**2. å…³é”®æ´å¯Ÿ**
* èŠ±è´¹ä¸ROASçš„ç›¸å…³æ€§åˆ†æã€‚
* åŸºäºæ•°æ®çš„å®¢è§‚è¯„ä»·ï¼ˆé¿å…ä½¿ç”¨â€œæå¥½â€ç­‰è¯æ±‡ï¼‰ã€‚

### ä¸‰ã€ æ ¸å¿ƒå•†å“å‘ˆç°åˆ†æ (é’ˆå¯¹æ¶ˆè€—TOP 1å•†å“)
**1. æ ‡é¢˜è¯Šæ–­**
* **å½“å‰æ ‡é¢˜**ï¼š[è‡ªåŠ¨å¡«å…¥æ¶ˆè€—æœ€é«˜çš„å•†å“æ ‡é¢˜]
* **é—®é¢˜è¯Šæ–­**ï¼š(ä¾‹å¦‚ï¼šå…³é”®è¯å †ç Œã€æœªåŒ…å«æ ¸å¿ƒå–ç‚¹ã€åªæœ‰å‹å·æ— å“ç±»åç­‰)
* **ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š(æä¾›2ä¸ªä¼˜åŒ–åçš„æ ‡é¢˜ï¼Œè¦æ±‚åŒ…å«å“ç±»å¤§è¯+æ ¸å¿ƒå–ç‚¹ï¼Œé€šä¿—æ˜“æ‡‚)

**2. ä¸»å›¾è¯Šæ–­**
* **åˆ†æå¯¹è±¡**ï¼š(è¯·ç»“åˆé™„ä»¶ä¸­çš„å•†å“ä¸»å›¾è¿›è¡Œåˆ†æ)
* **è§†è§‰å»ºè®®**ï¼š(ä¾‹å¦‚ï¼šèƒŒæ™¯æ‚ä¹±å»ºè®®çº¯ç™½åº•ã€ç¼ºä¹ä½¿ç”¨åœºæ™¯å»ºè®®å¢åŠ æ¨¡ç‰¹å›¾ã€å–ç‚¹ä¸çªå‡ºå»ºè®®å¢åŠ è´´ç‰‡æ–‡æ¡ˆ)

### å››ã€ ç´ æä¸å†…å®¹æ·±åº¦è¯Šæ–­

**1. ç´ æç»©æ•ˆè±¡é™åˆ†æ (è¡¨æ ¼)**
åŸºäºã€ç´ ææ˜ç»†æ•°æ®ã€‘ï¼Œå°†ç´ æåˆ†ç±»ã€‚
* **IDæ˜¾ç¤ºæ³¨æ„**ï¼šVideo IDå¿…é¡»å®Œæ•´æ˜¾ç¤ºã€‚

| ç´ æç±»å‹ | å®šä¹‰æ ‡å‡† | å…¸å‹Video ID (å®Œæ•´) | å»ºè®®æ“ä½œ |
| :--- | :--- | :--- | :--- |
| æ˜æ˜Ÿç´ æ | é«˜èŠ±è´¹/é«˜ROAS | ... | ä¿æŒé¢„ç®—/å°è¯•æ‹“é‡ |
| é—®é¢˜ç´ æ | é«˜èŠ±è´¹/ä½ROAS | ... | é™ä»·/æš‚åœ/ä¼˜åŒ–å‰3ç§’ |
| æ½œåŠ›ç´ æ | ä½èŠ±è´¹/é«˜ROAS | ... | é€æ­¥æä»·æµ‹è¯• |
| å¾…æ·˜æ±°ç´ æ | ä½èŠ±è´¹/ä½ROAS | ... | ç«‹å³å…³åœ |

**2. ä½ç»©æ•ˆè§†é¢‘æ·±åº¦å½’å› **
é’ˆå¯¹æä¾›çš„å…·ä½“è§†é¢‘æ–‡ä»¶è¿›è¡Œåˆ†æã€‚
*é‡ç‚¹åˆ†æä¸ºä½•è¯¥è§†é¢‘æŠ•æ”¾æ•ˆæœä¸ä½³ã€‚*

| æ—¶é—´ç‚¹ | ç”»é¢å†…å®¹ | æ–‡æ¡ˆ/æ—ç™½ | é—®é¢˜åˆ†æ (å®¢è§‚æè¿°) | ä¼˜åŒ–å»ºè®® (å¯æ‰§è¡Œ) |
| :--- | :--- | :--- | :--- | :--- |
| 0-3ç§’ | ... | ... | ... | ... |
| ä¸­æ®µ | ... | ... | ... | ... |
| ç»“å°¾ | ... | ... | ... | ... |

* **å¤±è´¥æ ¸å¿ƒå½’å› **ï¼šç”¨ä¸€å¥è¯æ€»ç»“è¯¥è§†é¢‘è½¬åŒ–å·®çš„åŸå› ï¼ˆå¦‚ï¼šå®Œæ’­ç‡ä½å¯¼è‡´æ— è½¬åŒ–ï¼Œæˆ–å¼•å¯¼ä¸‹å•ä¸æ˜ç¡®ï¼‰ã€‚

### äº”ã€ çˆ†æ¬¾è„šæœ¬å‚è€ƒ (SMEé€‚ç”¨ç‰ˆ)
**1. å¸‚åœºæ´å¯Ÿ**
åŸºäºä½ æ¨æ–­çš„[å“ç±»]å’Œ[å¸‚åœº]ï¼Œç®€è¿°è¯¥åœ°åŒºç”¨æˆ·çš„åŸºæœ¬åå¥½ã€‚

**2. ç®€æ˜“çˆ†æ¬¾å…¬å¼**
ä¸ºå®¢æˆ·æä¾›ä¸€ä¸ªä½æˆæœ¬ã€æ˜“ä¸Šæ‰‹çš„æ‹æ‘„è„šæœ¬æ¨¡æ¿ã€‚

| æ—¶é—´ | é˜¶æ®µ | ç”»é¢å»ºè®® (ä½æˆæœ¬æ–¹æ¡ˆ) | æ–‡æ¡ˆç¤ºä¾‹ |
| :--- | :--- | :--- | :--- |
| 0-3s | é»„é‡‘å¼€å¤´ | ... | ... |
| 3-10s | ç—›ç‚¹/å±•ç¤º | ... | ... |
| 10s+ | å¼•å¯¼ä¸‹å• | ... | ... |
"""

st.title("ğŸš€ GMV å…¨é“¾è·¯åˆ†æ (æ•°æ®+å›¾+è§†)")

# --- 2. ä¾§è¾¹æ ï¼šä¸Šä¼ åŒº (å…¨å¿…å¡«) ---
with st.sidebar:
    st.header("ğŸ“‚ èµ„æ–™ä¸Šä¼  (å…¨éƒ¨å¿…å¡«)")
    
    uploaded_excel = st.file_uploader("1. Excel æŠ¥è¡¨", type=["xlsx", "xls"])
    uploaded_image = st.file_uploader("2. å¹¿å‘Šå°é¢å›¾", type=["png", "jpg", "jpeg", "webp"])
    uploaded_video = st.file_uploader("3. å¹¿å‘Šè§†é¢‘", type=["mp4", "mov", "avi"])
    
    st.divider()
    analyze_btn = st.button("ğŸš€ å¼€å§‹è”åˆåˆ†æ", type="primary")

# --- 3. åŠŸèƒ½å‡½æ•° ---
def process_excel_data(file):
    """æå– Excel ä¸­çš„å…³é”® Sheet å¹¶è½¬ JSON"""
    try:
        xls = pd.ExcelFile(file)
        data_bundle = {}
        
        target_sheets = {
            "åˆ†æ—¶æ®µæ•°æ®": "åˆ†æ—¶æ®µè¡¨ç°",
            "å•†å“-gmv max": "å•†å“GMVæ˜ç»†",
            "ç´ æ-gmv max": "ç´ æGMVæ˜ç»†"
        }
        
        found = False
        for sheet_name in xls.sheet_names:
            clean_name = sheet_name.strip()
            for key, alias in target_sheets.items():
                if key in clean_name:
                    df = pd.read_excel(xls, sheet_name=sheet_name)
                    data_bundle[alias] = df.to_dict(orient='records')
                    found = True
        
        return str(data_bundle) if found else None
    except Exception as e:
        return None

def upload_media(file, mime_type):
    """ä¸Šä¼ åª’ä½“æ–‡ä»¶åˆ° Gemini"""
    try:
        with tempfile.NamedTemporaryFile(delete=False, suffix=f".{file.name.split('.')[-1]}") as tmp:
            tmp.write(file.getvalue())
            tmp_path = tmp.name
        
        g_file = genai.upload_file(tmp_path, mime_type=mime_type)
        return g_file
    except Exception as e:
        st.error(f"ä¸Šä¼ æ–‡ä»¶å¤±è´¥: {e}")
        return None

def wait_for_video(file_obj):
    """ç­‰å¾…è§†é¢‘å¤„ç†å®Œæˆ"""
    if not file_obj: return False
    with st.spinner(f"æ­£åœ¨è½¬ç è§†é¢‘: {file_obj.name}..."):
        while file_obj.state.name == "PROCESSING":
            time.sleep(2)
            file_obj = genai.get_file(file_obj.name)
        if file_obj.state.name != "ACTIVE":
            st.error("è§†é¢‘å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚")
            return False
    return True

# --- 4. ä¸»ç¨‹åº ---
if analyze_btn:
    # âŒ ä¸¥æ ¼æ ¡éªŒï¼šç¼ºä¸€ä¸å¯
    if not (uploaded_excel and uploaded_image and uploaded_video):
        # ä¿®å¤ç‚¹ï¼šè¿™é‡Œæ”¹æˆäº†å¤šè¡Œå†™æ³•ï¼Œé˜²æ­¢å¤åˆ¶æ—¶æ–­è¡ŒæŠ¥é”™
        st.error(
            "âš ï¸ èµ„æ–™ä¸å…¨ï¼è¯·å¿…é¡»åŒæ—¶ä¸Šä¼ ï¼šExcelã€å›¾ç‰‡ å’Œ è§†é¢‘ã€‚"
        )
    else:
        # 1. å¤„ç†æ•°æ®
        json_data = process_excel_data(uploaded_excel)
        
        if not json_data:
            st.error("âŒ Excel ä¸­æœªæ‰¾åˆ°æŒ‡å®šçš„æ•°æ® Sheet (åˆ†æ—¶æ®µ/å•†å“/ç´ æ)ã€‚")
        else:
            col1, col2 = st.columns([1, 1])
            
            # 2. å‡†å¤‡å†…å®¹
            user_content = [
                f"è¿™æ˜¯æŠ•æ”¾æ•°æ®(JSON)ï¼š\n{json_data}\n\nè¯·ç»“åˆå›¾ç‰‡å’Œè§†é¢‘è¿›è¡Œè”åˆåˆ†æã€‚",
            ]
            
            # 3. å¤„ç†ç´ æä¸Šä¼ 
            with col1:
                st.subheader("ğŸ“Š ç´ æé¢„è§ˆ")
                
                # å›¾ç‰‡
                st.info("ä¸Šä¼ å›¾ç‰‡...")
                img_file = upload_media(uploaded_image, "image/jpeg")
                if img_file:
                    user_content.append(img_file)
                    st.image(uploaded_image, caption="å°é¢å›¾", use_column_width=True)
                
                # è§†é¢‘
                st.info("ä¸Šä¼ è§†é¢‘å¹¶è½¬ç ...")
                vid_file = upload_media(uploaded_video, "video/mp4")
                if vid_file and wait_for_video(vid_file):
                    user_content.append(vid_file)
                    st.video(uploaded_video)

            # 4. è°ƒç”¨ AI
            with col2:
                st.subheader("ğŸ’¡ æ·±åº¦åˆ†ææŠ¥å‘Š")
                try:
                    model = genai.GenerativeModel(
                        model_name="gemini-2.5-pro",
                        system_instruction=GEM_SYSTEM_INSTRUCTION
                    )
                    
                    with st.spinner("æ­£åœ¨å¯¹æ¯”æ•°æ®ä¸ç´ æç»†èŠ‚..."):
                        response = model.generate_content(user_content)
                        st.markdown(response.text)
                        
                except Exception as e:
                    st.error(f"åˆ†æå‡ºé”™: {e}")
